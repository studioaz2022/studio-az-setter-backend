ğŸ“ GHL FORM WEBHOOK HIT
ğŸ“ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Form Payload (non-empty fields): {
  "Tattoo Style": "Realism",
  "Tattoo Title": "Lion and Roses",
  "Language Preference": "English",
  "First Tattoo": "Yes",
  "Artist Inquired (Deseado)": "Joan",
  "Whatsapp User?": "No",
  "Tattoo Color Preference": "Black & Grey",
  "Tattoo Placement": "Left inner forearm",
  "How Soon Is Client Deciding?": "Soonest possible",
  "Tattoo Summary": "A realistic, black and gray lion",
  "contact_id": "cx8QkqBYM13LnXkOvnQl",
  "first_name": "Leonel",
  "last_name": "Chavez",
  "full_name": "Leonel Chavez",
  "email": "chavezctz@gmail.com",
  "phone": "+18329390214",
  "tags": "consultation request,english,source: web widget",
  "country": "US",
  "date_created": "2025-12-20T06:00:24.057Z",
  "contact_source": "AI Tattoo Widget",
  "contact_type": "lead",
  "location": {
    "name": "Studio AZ Tattoo",
    "address": "333 Washington Ave N STE 100",
    "city": "Minneapolis",
    "state": "Minnesota",
    "country": "US",
    "postalCode": "55401",
    "fullAddress": "333 Washington Ave N STE 100, Minneapolis Minnesota 55401",
    "id": "mUemx2jG4wly4kJWBkI4"
  },
  "workflow": {
    "id": "f96f931a-ca9d-46fe-af2c-b0dab285bcc7",
    "name": "Lead Fills Out \"React Widget\""
  },
  "customData": {
    "contactId": "cx8QkqBYM13LnXkOvnQl"
  }
}
ğŸ”„ Updating existing contact: cx8QkqBYM13LnXkOvnQl
ğŸ‘¤ Contact: Leonel Chavez
ğŸ‘¤ Contact ID: cx8QkqBYM13LnXkOvnQl
ğŸ“© Form message/notes: New form submission
ğŸ“‹ Contact custom fields (non-empty): {
  "etxasc6qlyxraku18kbz": "English",
  "h3psn8tzsw1kyckhjn9d": "Joan",
  "kxtfzydeskuys5lltksr": "Large",
  "qqdydmy1fnldidlcmnbc": "No",
  "ra4nk80wma8eqklcfxst": "Soonest possible",
  "12b2o4ydlfo99fa4ycuk": "Realism",
  "8jqgdvjraabsqgueqj3a": "Lion and Roses",
  "fnydobmyqnxdxlljy5oe": "Yes",
  "szyropmdmcitudhhb8dd": "Black & Grey",
  "jd8yhvksbi4agqjqoeov": "Left inner forearm",
  "xagtmfmbxtfchdo2oyf7": "A realistic, black and gray lion",
  "tattoo_style": "Realism",
  "tattoo_title": "Lion and Roses",
  "language_preference": "English",
  "first_tattoo": "Yes",
  "whatsapp_user": "No",
  "tattoo_color_preference": "Black & Grey",
  "tattoo_placement": "Left inner forearm",
  "how_soon_is_client_deciding": "Soonest possible",
  "tattoo_summary": "A realistic, black and gray lion"
}
ğŸ“Š [PIPELINE] New lead from Widget/Form - syncing entry stage to INTAKE...
ğŸ“Š [PIPELINE] Widget/form channel â†’ starting at INTAKE
âœ… [PIPELINE] Entry stage set: INTAKE (contact: cx8QkqBYM13LnXkOvnQl)
ğŸ“œ Fetching conversation history...
ğŸ“œ Fetched 0 messages for contact cx8QkqBYM13LnXkOvnQl
ğŸ“œ Thread context: {
  totalMessages: 0,
  recentCount: 0,
  hasSummary: false,
  hasImageContext: false,
  wasHumanHandling: false
}
ğŸ§  [AI CONTEXT] Processing message: {
  messageText: 'New form submission',
  contactId: 'cx8QkqBYM13LnXkOvnQl',
  contactName: 'Leonel Chavez',
  consultExplained: undefined,
  threadStats: {
    totalMessages: 0,
    recentMessages: 0,
    hasSummary: false,
    hasImageContext: false,
    wasHumanHandling: false
  }
}
ğŸ“Š [CANONICAL] State before routing: {
  tattooSummary: 'A realistic, black and gray lion',
  tattooPlacement: 'Left inner forearm',
  tattooSize: null,
  timeline: 'Soonest possible',
  consultationType: null,
  depositPaid: false,
  derivedPhase: 'consult_path'
}
ğŸ¯ [INTENTS] No specific intents detected for: New form submission
âœ‰ï¸ sendConversationMessage context: { contactId: 'cx8QkqBYM13LnXkOvnQl', isDm: false, hasPhone: false }
inferConversationMessageType: unrecognized lastMessageType=TYPE_NO_SHOW, defaulting to FB for DM
âŒ Error sending message via GHL (fallback): {
  status: 400,
  message: 'Contact has no Facebook id, skipping',
  name: 'HttpException',
  traceId: '655589ac-30e4-4d75-8aee-bd0aa066091a'
}
âŒ Failed to send proactive consult options: Request failed with status code 400
  currentStage: '(none)',
  targetStage: 'CONSULT_MESSAGE',
  context: {
    aiPhase: 'consult_support',
    depositLinkSent: false,
    depositPaid: false,
    consultType: 'message',
    hasUpcomingTattoo: false,
    tattooCompleted: false,
    lost: false
  }
}
ğŸ“Š [PIPELINE] Transitioning opportunity DlkVUVQDWmTSp079m4sg: DISCOVERY â†’ CONSULT_MESSAGE
âœ… [PIPELINE] Stage transition: (none) â†’ CONSULT_MESSAGE (contact: cx8QkqBYM13LnXkOvnQl)
ğŸ—ï¸ Pipeline stage synced after consult mode = message
ğŸ§­ [PHASE] derived_phase snapshot {
  derived_phase: 'consult_path',
  canonical: {
    tattooSummary: 'A realistic, black and gray lion',
    tattooPlacement: 'Left inner forearm',
    tattooSize: null,
    timeline: 'Soonest possible',
    consultationType: null,
    consultationTypeLocked: false,
    depositLinkSent: false,
    depositPaid: false,
    holdAppointmentId: null
  },
  intents: {
    reschedule_intent: false,
    cancel_intent: false,
    scheduling_intent: false,
    slot_selection_intent: false,
    deposit_intent: false,
    consult_path_choice_intent: true,
    artist_guided_size_intent: false,
    process_or_price_question_intent: false
  },
  selected_handler: 'consult_path',
  routing_reason: 'consult_path_choice_intent',
  intent_flags: [ 'consult_path_choice_intent' ]
}
â±ï¸ [TIMING] Total handleInboundMessage took 2587ms
ğŸ¤– AI Response Summary: {
  bubblesCount: 0,
  phase: 'consult_path',
  handler: 'consult_path',
  reason: 'consult_path_choice_intent',
  fieldUpdatesKeys: []
}
ğŸ“¤ Sent 0/0 bubbles to GHL conversation
â„¹ï¸ No field_updates from AI to persist this turn
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ GHL MESSAGE WEBHOOK HIT
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Webhook Payload (non-empty fields): {
  "Tattoo Style": "Realism",
  "Tattoo Title": "Lion and Roses",
  "Language Preference": "English",
  "First Tattoo": "Yes",
  "Artist Inquired (Deseado)": "Joan",
  "Whatsapp User?": "No",
  "Tattoo Color Preference": "Black & Grey",
  "consultation_type": "message",
  "Tattoo Placement": "Left inner forearm",
  "translator_needed": "No",
  "How Soon Is Client Deciding?": "Soonest possible",
  "Tattoo Summary": "A realistic, black and gray lion",
  "contact_id": "cx8QkqBYM13LnXkOvnQl",
  "first_name": "Leonel",
  "last_name": "Chavez",
  "full_name": "Leonel Chavez",
  "email": "chavezctz@gmail.com",
  "phone": "+18329390214",
  "tags": "consultation request,english,source: web widget",
  "country": "US",
  "date_created": "2025-12-20T06:00:24.057Z",
  "contact_source": "AI Tattoo Widget",
  "contact_type": "lead",
  "location": {
    "name": "Studio AZ Tattoo",
    "address": "333 Washington Ave N STE 100",
    "city": "Minneapolis",
    "state": "Minnesota",
    "country": "US",
    "postalCode": "55401",
    "fullAddress": "333 Washington Ave N STE 100, Minneapolis Minnesota 55401",
    "id": "mUemx2jG4wly4kJWBkI4"
  },
  "message": {
    "type": 2,
    "body": "Thanks for the prompt response. I feel like I can message the artist directly."
  },
  "workflow": {
    "id": "8cf237bb-6cb1-4240-8ca5-b797bba8b769",
    "name": "Testing Ai Bot"
  },
  "customData": {
    "contactId": "cx8QkqBYM13LnXkOvnQl",
    "messageBody": "Thanks for the prompt response. I feel like I can message the artist directly."
  }
}
ğŸ“© Incoming message text: Thanks for the prompt response. I feel like I can message the artist directly.
ğŸ‘¤ Contact ID: cx8QkqBYM13LnXkOvnQl
ğŸ“‹ Webhook custom fields extracted: {
  "tattoo_style": "Realism",
  "tattoo_title": "Lion and Roses",
  "language_preference": "English",
  "first_tattoo": "Yes",
  "whatsapp_user": "No",
  "tattoo_color_preference": "Black & Grey",
  "consultation_type": "message",
  "tattoo_placement": "Left inner forearm",
  "translator_needed": "No",
  "how_soon_is_client_deciding": "Soonest possible",
  "tattoo_summary": "A realistic, black and gray lion"
}
ğŸ‘¤ Contact: Leonel Chavez
ğŸ“‹ Contact custom fields (merged): {
  "etxasc6qlyxraku18kbz": "English",
  "h3psn8tzsw1kyckhjn9d": "Joan",
  "kxtfzydeskuys5lltksr": "Large",
  "qqdydmy1fnldidlcmnbc": "No",
  "ra4nk80wma8eqklcfxst": "Soonest possible",
  "12b2o4ydlfo99fa4ycuk": "Realism",
  "8jqgdvjraabsqgueqj3a": "Lion and Roses",
  "fnydobmyqnxdxlljy5oe": "Yes",
  "szyropmdmcitudhhb8dd": "Black & Grey",
  "jd8yhvksbi4agqjqoeov": "Left inner forearm",
  "xagtmfmbxtfchdo2oyf7": "A realistic, black and gray lion",
  "gm2pvo90ynbdhekv5g64": "message",
  "qvuq2wdv3drhbkhts6td": "No",
  "tattoo_style": "Realism",
  "tattoo_title": "Lion and Roses",
  "language_preference": "English",
  "first_tattoo": "Yes",
  "whatsapp_user": "No",
  "tattoo_color_preference": "Black & Grey",
  "consultation_type": "message",
  "tattoo_placement": "Left inner forearm",
  "translator_needed": "No",
  "how_soon_is_client_deciding": "Soonest possible",
  "tattoo_summary": "A realistic, black and gray lion"
}
ğŸ“¡ Channel context: {
  isDm: false,
  hasPhone: true,
  isWhatsApp: false,
  isSms: true,
  channelType: 'sms',
  conversationId: null,
  phone: '+18329390214'
}
ğŸ“Š [PIPELINE] New lead from sms - syncing entry stage...
ğŸ“Š [PIPELINE] Direct channel (sms) â†’ starting at DISCOVERY
ğŸ“œ Fetching conversation history...
ğŸ“œ Fetched 8 messages for contact cx8QkqBYM13LnXkOvnQl
ğŸ“œ Thread context: {
  totalMessages: 8,
  recentCount: 8,
  hasSummary: false,
  hasImageContext: false,
  wasHumanHandling: true,
  isReturningClient: false
}
ğŸ§  [AI CONTEXT] Processing message: {
  messageText: 'Thanks for the prompt response. I feel like I can message the artist directly.',
  contactId: 'cx8QkqBYM13LnXkOvnQl',
  contactName: 'Leonel Chavez',
  consultExplained: undefined,
  threadStats: {
    totalMessages: 8,
    recentMessages: 8,
    hasSummary: false,
    hasImageContext: false,
    wasHumanHandling: true
  }
}
ğŸ“Š [CANONICAL] State before routing: {
  tattooSummary: 'A realistic, black and gray lion',
  tattooPlacement: 'Left inner forearm',
  tattooSize: null,
  timeline: 'Soonest possible',
  consultationType: 'message',
  depositPaid: false,
  derivedPhase: 'discovery'
}
ğŸ¯ [INTENTS] Detected intents: [ 'consult_path_choice_intent' ] from message: Thanks for the prompt response. I feel like I can message the artist directly.
ğŸ“ [CONSULTATION_TYPE] Setting consultation_type="message" for contact cx8QkqBYM13LnXkOvnQl (detected from: "Thanks for the prompt response. I feel like I can message the artist directly.")
âŒ Failed to create message consult task: Request failed with status code 422
âœ‰ï¸ sendConversationMessage context: { contactId: 'cx8QkqBYM13LnXkOvnQl', isDm: false, hasPhone: false }
ğŸ“¨ GHL conversations API response (fallback): { status: 201, contactId: 'cx8QkqBYM13LnXkOvnQl', type: 'SMS' }
ğŸ“ [CONSULTATION_TYPE] Sent message-path confirmation directly
ğŸ”„ [PIPELINE] Syncing opportunity stage for contact cx8QkqBYM13LnXkOvnQl: {
  currentStage: '(none)',
  targetStage: 'CONSULT_MESSAGE',
  context: {
    aiPhase: 'consult_support',
    depositLinkSent: false,
    depositPaid: false,
    consultType: 'message',
    hasUpcomingTattoo: false,
    tattooCompleted: false,
    lost: false
  }
}
âœ… [PIPELINE] Stage transition: (none) â†’ CONSULT_MESSAGE (contact: cx8QkqBYM13LnXkOvnQl)
ğŸ—ï¸ Pipeline stage synced after consult mode = message
ğŸ§­ [PHASE] derived_phase snapshot {
  derived_phase: 'discovery',
  canonical: {
    tattooSummary: 'A realistic, black and gray lion',
    tattooPlacement: 'Left inner forearm',
    tattooSize: null,
    timeline: 'Soonest possible',
    consultationType: 'message',
    consultationTypeLocked: false,
    depositLinkSent: false,
    depositPaid: false,
    holdAppointmentId: null
  },
  intents: {
    reschedule_intent: false,
    cancel_intent: false,
    scheduling_intent: false,
    slot_selection_intent: false,
    deposit_intent: false,
    consult_path_choice_intent: true,
    artist_guided_size_intent: false,
    process_or_price_question_intent: false
  },
  selected_handler: 'consult_path',
  routing_reason: 'consult_path_choice_intent',
  intent_flags: [ 'consult_path_choice_intent' ]
}
â±ï¸ [TIMING] Total handleInboundMessage took 2558ms
ğŸ¤– AI Response Summary: {
  bubblesCount: 0,
  phase: 'discovery',
  handler: 'consult_path',
  reason: 'consult_path_choice_intent',
  fieldUpdatesKeys: []
}
ğŸ“¤ Sent 0/0 bubbles to GHL conversation
â„¹ï¸ No field_updates from AI to persist this turn
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•