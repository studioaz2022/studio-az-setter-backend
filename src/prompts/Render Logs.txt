ğŸ’¬ GHL MESSAGE WEBHOOK HIT
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Webhook Payload (non-empty fields): {
  "contact_id": "0mMtk2qB0rcAaGBislYN",
  "first_name": "Maria",
  "last_name": "Claflin",
  "full_name": "Maria Claflin",
  "tags": "dm consultation request",
  "date_created": "2025-12-16T06:56:26.803Z",
  "contact_type": "lead",
  "location": {
    "name": "Studio AZ Tattoo",
    "address": "333 Washington Ave N STE 100",
    "city": "Minneapolis",
    "state": "Minnesota",
    "country": "US",
    "postalCode": "55401",
    "fullAddress": "333 Washington Ave N STE 100, Minneapolis Minnesota 55401",
    "id": "mUemx2jG4wly4kJWBkI4"
  },
  "message": {
    "type": 11,
    "body": "I would like to book a tattoo"
  },
  "workflow": {
    "id": "8cf237bb-6cb1-4240-8ca5-b797bba8b769",
    "name": "Testing Ai Bot"
  },
  "contact": {
    "attributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    },
    "lastAttributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    }
  },
  "customData": {
    "contactId": "0mMtk2qB0rcAaGBislYN",
    "messageBody": "I would like to book a tattoo"
  }
}
ğŸ“© Incoming message text: I would like to book a tattoo
ğŸ‘¤ Contact ID: 0mMtk2qB0rcAaGBislYN
ğŸ“‹ Webhook custom fields extracted: {}
ğŸ‘¤ Contact: Maria Claflin
ğŸ“‹ Contact custom fields (merged): {}
ğŸ“¡ Channel context: {
  isDm: true,
  hasPhone: false,
  isWhatsApp: false,
  isSms: false,
  channelType: 'facebook',
  conversationId: null,
  phone: null
}
ğŸ“Š [PIPELINE] New lead from facebook - syncing entry stage...
ğŸ“Š [PIPELINE] Direct channel (facebook) â†’ starting at DISCOVERY
âŒ [PIPELINE] Failed to set entry stage: Request failed with status code 422
ğŸ§  [AI CONTEXT] Processing message: {
  messageText: 'I would like to book a tattoo',
  contactId: '0mMtk2qB0rcAaGBislYN',
  contactName: 'Maria Claflin',
  consultExplained: undefined
}
ğŸ“Š [CANONICAL] State before routing: {
  tattooSummary: null,
  tattooPlacement: null,
  tattooSize: null,
  timeline: null,
  consultationType: null,
  depositPaid: false,
  derivedPhase: 'intake'
}
ğŸ¯ [INTENTS] No specific intents detected for: I would like to book a tattoo
ğŸ¤– Raw OpenAI opener response: {
  "language": "en",
  "bubbles": [
    "Hey Maria! What kind of piece are you thinking?",
    "Where on your body were you wanting to get it?"
  ],
  "internal_notes": "Opening message to start intake phase by gathering tattoo idea and placement.",
  "meta": {
    "aiPhase": "intake",
    "leadTemperature": "warm",
    "wantsDepositLink": false,
    "depositPushedThisTurn": false,
    "mentionDecoyOffered": false,
    "consultMode": "online"
  },
  "field_updates": {}
}
â±ï¸ [TIMING] AI call took 2816ms
ğŸ§­ [PHASE] derived_phase snapshot {
  derived_phase: 'intake',
  canonical: {
    tattooSummary: null,
    tattooPlacement: null,
    tattooSize: null,
    timeline: null,
    consultationType: null,
    consultationTypeLocked: false,
    depositLinkSent: false,
    depositPaid: false,
    holdAppointmentId: null
  },
  intents: {
    reschedule_intent: false,
    cancel_intent: false,
    scheduling_intent: false,
    slot_selection_intent: false,
    deposit_intent: false,
    consult_path_choice_intent: false,
    artist_guided_size_intent: false,
    process_or_price_question_intent: false,
    translator_affirm_intent: false
  },
  selected_handler: 'ai',
  routing_reason: 'ai_fallback',
  intent_flags: []
}
â±ï¸ [TIMING] Total handleInboundMessage took 2819ms
ğŸ¤– AI Response Summary: {
  bubblesCount: 2,
  phase: 'intake',
  handler: 'ai',
  reason: 'ai_fallback',
  fieldUpdatesKeys: []
}
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: true, hasPhone: false }
ğŸ” No conversationId provided for DM, searching for DM conversation...
ğŸ” No DM conversation found for contact
ğŸ” No existing DM conversation found, will try to infer type from contact...
ğŸ” No DM conversation found for contact
inferConversationMessageType: no DM conversation found, checking contact tags...
ğŸ“¨ Sending DM via GHL (creating new conversation): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  locationId: 'mUemx2jG4wly4kJWBkI4',
  message: 'Hey Maria! What kind of piece are you thinking?',
  type: 'FB'
}
ğŸ“¨ GHL DM message response (new conversation): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: true, hasPhone: false }
ğŸ” No conversationId provided for DM, searching for DM conversation...
ğŸ” No DM conversation found for contact
ğŸ” No existing DM conversation found, will try to infer type from contact...
ğŸ” No DM conversation found for contact
inferConversationMessageType: no DM conversation found, checking contact tags...
ğŸ“¨ Sending DM via GHL (creating new conversation): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  locationId: 'mUemx2jG4wly4kJWBkI4',
  message: 'Where on your body were you wanting to get it?',
  type: 'FB'
}
ğŸ“¨ GHL DM message response (new conversation): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
ğŸ“¤ Sent 2/2 bubbles to GHL conversation
â„¹ï¸ No field_updates from AI to persist this turn
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ GHL MESSAGE WEBHOOK HIT
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Webhook Payload (non-empty fields): {
  "contact_id": "0mMtk2qB0rcAaGBislYN",
  "first_name": "Maria",
  "last_name": "Claflin",
  "full_name": "Maria Claflin",
  "tags": "dm consultation request",
  "date_created": "2025-12-16T06:56:26.803Z",
  "contact_type": "lead",
  "location": {
    "name": "Studio AZ Tattoo",
    "address": "333 Washington Ave N STE 100",
    "city": "Minneapolis",
    "state": "Minnesota",
    "country": "US",
    "postalCode": "55401",
    "fullAddress": "333 Washington Ave N STE 100, Minneapolis Minnesota 55401",
    "id": "mUemx2jG4wly4kJWBkI4"
  },
  "message": {
    "type": 11,
    "body": "I was thinking of some pine trees on my forearm"
  },
  "workflow": {
    "id": "8cf237bb-6cb1-4240-8ca5-b797bba8b769",
    "name": "Testing Ai Bot"
  },
  "contact": {
    "attributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    },
    "lastAttributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    }
  },
  "customData": {
    "contactId": "0mMtk2qB0rcAaGBislYN",
    "messageBody": "I was thinking of some pine trees on my forearm"
  }
}
ğŸ“© Incoming message text: I was thinking of some pine trees on my forearm
ğŸ‘¤ Contact ID: 0mMtk2qB0rcAaGBislYN
ğŸ“‹ Webhook custom fields extracted: {}
ğŸ‘¤ Contact: Maria Claflin
ğŸ“‹ Contact custom fields (merged): {}
ğŸ“¡ Channel context: {
  isDm: true,
  hasPhone: false,
  isWhatsApp: false,
  isSms: false,
  channelType: 'facebook',
  conversationId: null,
  phone: null
}
ğŸ“Š [PIPELINE] New lead from facebook - syncing entry stage...
ğŸ“Š [PIPELINE] Direct channel (facebook) â†’ starting at DISCOVERY
âŒ [PIPELINE] Failed to set entry stage: Request failed with status code 422
ğŸ§  [AI CONTEXT] Processing message: {
  messageText: 'I was thinking of some pine trees on my forearm',
  contactId: '0mMtk2qB0rcAaGBislYN',
  contactName: 'Maria Claflin',
  consultExplained: undefined
}
ğŸ“Š [CANONICAL] State before routing: {
  tattooSummary: null,
  tattooPlacement: null,
  tattooSize: null,
  timeline: null,
  consultationType: null,
  depositPaid: false,
  derivedPhase: 'intake'
}
ğŸ¯ [INTENTS] No specific intents detected for: I was thinking of some pine trees on my forearm
ğŸ¤– Raw OpenAI opener response: {
  "language": "en",
  "bubbles": [
    "That forearm pine tree idea is gonna look sick.",
    "When were you thinking about getting it done?"
  ],
  "internal_notes": "Acknowledged tattoo idea and placement; asked about timing to continue intake.",
  "meta": {
    "aiPhase": "intake",
    "leadTemperature": "warm",
    "wantsDepositLink": false,
    "depositPushedThisTurn": false,
    "mentionDecoyOffered": false,
    "wantsAppointmentOffer": false,
    "consultMode": "online"
  },
  "field_updates": {
    "tattoo_placement": "forearm",
    "tattoo_summary": "pine trees",
    "tattoo_style": "nature/trees"
  }
}
â±ï¸ [TIMING] AI call took 3569ms
ğŸ§­ [PHASE] derived_phase snapshot {
  derived_phase: 'discovery',
  canonical: {
    tattooSummary: 'pine trees',
    tattooPlacement: 'forearm',
    tattooSize: null,
    timeline: null,
    consultationType: null,
    consultationTypeLocked: false,
    depositLinkSent: false,
    depositPaid: false,
    holdAppointmentId: null
  },
  intents: {
    reschedule_intent: false,
    cancel_intent: false,
    scheduling_intent: false,
    slot_selection_intent: false,
    deposit_intent: false,
    consult_path_choice_intent: false,
    artist_guided_size_intent: false,
    process_or_price_question_intent: false,
    translator_affirm_intent: false
  },
  selected_handler: 'ai',
  routing_reason: 'ai_fallback',
  intent_flags: []
}
â±ï¸ [TIMING] Total handleInboundMessage took 3759ms
ğŸ¤– AI Response Summary: {
  bubblesCount: 2,
  phase: 'discovery',
  handler: 'ai',
  reason: 'ai_fallback',
  fieldUpdatesKeys: [ 'tattoo_placement', 'tattoo_summary', 'tattoo_style' ]
}
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: true, hasPhone: false }
ğŸ” No conversationId provided for DM, searching for DM conversation...
ğŸ” No DM conversation found for contact
ğŸ” No existing DM conversation found, will try to infer type from contact...
ğŸ” No DM conversation found for contact
inferConversationMessageType: no DM conversation found, checking contact tags...
ğŸ“¨ Sending DM via GHL (creating new conversation): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  locationId: 'mUemx2jG4wly4kJWBkI4',
  message: 'That forearm pine tree idea is gonna look sick.',
  type: 'FB'
}
ğŸ“¨ GHL DM message response (new conversation): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: true, hasPhone: false }
ğŸ” No conversationId provided for DM, searching for DM conversation...
ğŸ” No DM conversation found for contact
ğŸ” No existing DM conversation found, will try to infer type from contact...
ğŸ” No DM conversation found for contact
inferConversationMessageType: no DM conversation found, checking contact tags...
ğŸ“¨ Sending DM via GHL (creating new conversation): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  locationId: 'mUemx2jG4wly4kJWBkI4',
  message: 'When were you thinking about getting it done?',
  type: 'FB'
}
ğŸ“¨ GHL DM message response (new conversation): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
ğŸ“¤ Sent 2/2 bubbles to GHL conversation
âœ… Updated tattoo fields for contact 0mMtk2qB0rcAaGBislYN with {
  tattoo_placement: 'forearm',
  tattoo_summary: 'pine trees',
  tattoo_style: 'nature/trees'
}
âœ… Persisted field_updates: [ 'tattoo_placement', 'tattoo_summary', 'tattoo_style' ]
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ GHL MESSAGE WEBHOOK HIT
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Webhook Payload (non-empty fields): {
  "Tattoo Style": "nature/trees",
  "Tattoo Placement": "forearm",
  "Tattoo Summary": "pine trees",
  "contact_id": "0mMtk2qB0rcAaGBislYN",
  "first_name": "Maria",
  "last_name": "Claflin",
  "full_name": "Maria Claflin",
  "tags": "dm consultation request",
  "country": "US",
  "date_created": "2025-12-16T06:56:26.803Z",
  "contact_type": "lead",
  "location": {
    "name": "Studio AZ Tattoo",
    "address": "333 Washington Ave N STE 100",
    "city": "Minneapolis",
    "state": "Minnesota",
    "country": "US",
    "postalCode": "55401",
    "fullAddress": "333 Washington Ave N STE 100, Minneapolis Minnesota 55401",
    "id": "mUemx2jG4wly4kJWBkI4"
  },
  "message": {
    "type": 11,
    "body": "In January !"
  },
  "workflow": {
    "id": "8cf237bb-6cb1-4240-8ca5-b797bba8b769",
    "name": "Testing Ai Bot"
  },
  "contact": {
    "attributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    },
    "lastAttributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    }
  },
  "customData": {
    "contactId": "0mMtk2qB0rcAaGBislYN",
    "messageBody": "In January !"
  }
}
ğŸ“© Incoming message text: In January !
ğŸ‘¤ Contact ID: 0mMtk2qB0rcAaGBislYN
ğŸ“‹ Webhook custom fields extracted: {
  "tattoo_style": "nature/trees",
  "tattoo_placement": "forearm",
  "tattoo_summary": "pine trees"
}
ğŸ‘¤ Contact: Maria Claflin
ğŸ“‹ Contact custom fields (merged): {
  "12b2o4ydlfo99fa4ycuk": "nature/trees",
  "jd8yhvksbi4agqjqoeov": "forearm",
  "xagtmfmbxtfchdo2oyf7": "pine trees",
  "tattoo_style": "nature/trees",
  "tattoo_placement": "forearm",
  "tattoo_summary": "pine trees"
}
ğŸ“¡ Channel context: {
  isDm: true,
  hasPhone: false,
  isWhatsApp: false,
  isSms: false,
  channelType: 'facebook',
  conversationId: null,
  phone: null
}
ğŸ“Š [PIPELINE] New lead from facebook - syncing entry stage...
ğŸ“Š [PIPELINE] Direct channel (facebook) â†’ starting at DISCOVERY
âŒ [PIPELINE] Failed to set entry stage: Request failed with status code 422
ğŸ§  [AI CONTEXT] Processing message: {
  messageText: 'In January !',
  contactId: '0mMtk2qB0rcAaGBislYN',
  contactName: 'Maria Claflin',
  consultExplained: undefined
}
ğŸ“Š [CANONICAL] State before routing: {
  tattooSummary: 'pine trees',
  tattooPlacement: 'forearm',
  tattooSize: null,
  timeline: null,
  consultationType: null,
  depositPaid: false,
  derivedPhase: 'discovery'
}
ğŸ¯ [INTENTS] No specific intents detected for: In January !
ğŸ¤– Raw OpenAI opener response: {
  "language": "en",
  "bubbles": [
    "January works. Perfect, we can make that happen.",
    "The next step is a quick 15â€“20 minute consultation with the artist to fully understand your design.",
    "Since our artist's native language is Spanish, clients either do a video call with a translator or message the artist directly about their idea. Which do you prefer?"
  ],
  "internal_notes": "Acknowledged timeline and tattoo idea, explained consult process and asked for consult mode preference.",
  "meta": {
    "aiPhase": "qualification",
    "leadTemperature": "warm",
    "wantsDepositLink": false,
    "depositPushedThisTurn": false,
    "mentionDecoyOffered": false,
    "wantsAppointmentOffer": false,
    "consultMode": "online"
  },
  "field_updates": {
    "how_soon_is_client_deciding": "January"
  }
}
â±ï¸ [TIMING] AI call took 3329ms
ğŸ§­ [PHASE] derived_phase snapshot {
  derived_phase: 'consult_path',
  canonical: {
    tattooSummary: 'pine trees',
    tattooPlacement: 'forearm',
    tattooSize: null,
    timeline: 'January',
    consultationType: null,
    consultationTypeLocked: false,
    depositLinkSent: false,
    depositPaid: false,
    holdAppointmentId: null
  },
  intents: {
    reschedule_intent: false,
    cancel_intent: false,
    scheduling_intent: false,
    slot_selection_intent: false,
    deposit_intent: false,
    consult_path_choice_intent: false,
    artist_guided_size_intent: false,
    process_or_price_question_intent: false,
    translator_affirm_intent: false
  },
  selected_handler: 'ai',
  routing_reason: 'ai_fallback',
  intent_flags: []
}
â±ï¸ [TIMING] Total handleInboundMessage took 3551ms
ğŸ¤– AI Response Summary: {
  bubblesCount: 3,
  phase: 'consult_path',
  handler: 'ai',
  reason: 'ai_fallback',
  fieldUpdatesKeys: [ 'how_soon_is_client_deciding' ]
}
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: true, hasPhone: false }
ğŸ” No conversationId provided for DM, searching for DM conversation...
ğŸ” No DM conversation found for contact
ğŸ” No existing DM conversation found, will try to infer type from contact...
inferConversationMessageType: no DM conversation found, checking contact tags...
ğŸ” No DM conversation found for contact
ğŸ“¨ Sending DM via GHL (creating new conversation): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  locationId: 'mUemx2jG4wly4kJWBkI4',
  message: 'January works. Perfect, we can make that happen.',
  type: 'FB'
}
ğŸ“¨ GHL DM message response (new conversation): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: true, hasPhone: false }
ğŸ” No conversationId provided for DM, searching for DM conversation...
ğŸ” No DM conversation found for contact
ğŸ” No existing DM conversation found, will try to infer type from contact...
ğŸ” No DM conversation found for contact
inferConversationMessageType: no DM conversation found, checking contact tags...
ğŸ“¨ Sending DM via GHL (creating new conversation): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  locationId: 'mUemx2jG4wly4kJWBkI4',
  message: 'The next step is a quick 15â€“20 minute consultation with the artist to fully understand your design.',
  type: 'FB'
}
ğŸ“¨ GHL DM message response (new conversation): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: true, hasPhone: false }
ğŸ” No conversationId provided for DM, searching for DM conversation...
ğŸ” No DM conversation found for contact
ğŸ” No existing DM conversation found, will try to infer type from contact...
inferConversationMessageType: no DM conversation found, checking contact tags...
ğŸ” No DM conversation found for contact
ğŸ“¨ Sending DM via GHL (creating new conversation): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  locationId: 'mUemx2jG4wly4kJWBkI4',
  message: "Since our artist's native language is Spanish, clients either do a video call with a translator or message the artist directly about their idea. Which do you prefer?",
  type: 'FB'
}
ğŸ“¨ GHL DM message response (new conversation): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
ğŸ“¤ Sent 3/3 bubbles to GHL conversation
âœ… Updated tattoo fields for contact 0mMtk2qB0rcAaGBislYN with { how_soon_is_client_deciding: 'January' }
âœ… Persisted field_updates: [ 'how_soon_is_client_deciding' ]
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ GHL MESSAGE WEBHOOK HIT
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Webhook Payload (non-empty fields): {
  "Tattoo Style": "nature/trees",
  "Tattoo Placement": "forearm",
  "How Soon Is Client Deciding?": "January",
  "Tattoo Summary": "pine trees",
  "contact_id": "0mMtk2qB0rcAaGBislYN",
  "first_name": "Maria",
  "last_name": "Claflin",
  "full_name": "Maria Claflin",
  "tags": "dm consultation request",
  "country": "US",
  "date_created": "2025-12-16T06:56:26.803Z",
  "contact_type": "lead",
  "location": {
    "name": "Studio AZ Tattoo",
    "address": "333 Washington Ave N STE 100",
    "city": "Minneapolis",
    "state": "Minnesota",
    "country": "US",
    "postalCode": "55401",
    "fullAddress": "333 Washington Ave N STE 100, Minneapolis Minnesota 55401",
    "id": "mUemx2jG4wly4kJWBkI4"
  },
  "message": {
    "type": 11,
    "body": "I prefer a video call"
  },
  "workflow": {
    "id": "8cf237bb-6cb1-4240-8ca5-b797bba8b769",
    "name": "Testing Ai Bot"
  },
  "contact": {
    "attributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    },
    "lastAttributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    }
  },
  "customData": {
    "contactId": "0mMtk2qB0rcAaGBislYN",
    "messageBody": "I prefer a video call"
  }
}
ğŸ“© Incoming message text: I prefer a video call
ğŸ‘¤ Contact ID: 0mMtk2qB0rcAaGBislYN
ğŸ“‹ Webhook custom fields extracted: {
  "tattoo_style": "nature/trees",
  "tattoo_placement": "forearm",
  "how_soon_is_client_deciding": "January",
  "tattoo_summary": "pine trees"
}
ğŸ‘¤ Contact: Maria Claflin
ğŸ“‹ Contact custom fields (merged): {
  "12b2o4ydlfo99fa4ycuk": "nature/trees",
  "jd8yhvksbi4agqjqoeov": "forearm",
  "xagtmfmbxtfchdo2oyf7": "pine trees",
  "ra4nk80wma8eqklcfxst": "January",
  "tattoo_style": "nature/trees",
  "tattoo_placement": "forearm",
  "how_soon_is_client_deciding": "January",
  "tattoo_summary": "pine trees"
}
ğŸ“¡ Channel context: {
  isDm: true,
  hasPhone: false,
  isWhatsApp: false,
  isSms: false,
  channelType: 'facebook',
  conversationId: null,
  phone: null
}
ğŸ“Š [PIPELINE] New lead from facebook - syncing entry stage...
ğŸ“Š [PIPELINE] Direct channel (facebook) â†’ starting at DISCOVERY
âŒ [PIPELINE] Failed to set entry stage: Request failed with status code 422
ğŸ§  [AI CONTEXT] Processing message: {
  messageText: 'I prefer a video call',
  contactId: '0mMtk2qB0rcAaGBislYN',
  contactName: 'Maria Claflin',
  consultExplained: undefined
}
ğŸ“Š [CANONICAL] State before routing: {
  tattooSummary: 'pine trees',
  tattooPlacement: 'forearm',
  tattooSize: null,
  timeline: 'January',
  consultationType: null,
  depositPaid: false,
  derivedPhase: 'consult_path'
}
ğŸ¯ [INTENTS] Detected intents: [ 'consult_path_choice_intent' ] from message: I prefer a video call
ğŸ“ [CONSULTATION_TYPE] Setting consultation_type="appointment" (translator needed) for contact 0mMtk2qB0rcAaGBislYN (detected from: "I prefer a video call")
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: false, hasPhone: false }
ğŸ“¨ GHL conversations API response (fallback): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
ğŸ“ [CONSULTATION_TYPE] Sent translator explanation message directly
ğŸ”„ [PIPELINE] Syncing opportunity stage for contact 0mMtk2qB0rcAaGBislYN: {
  currentStage: '(none)',
  targetStage: 'CONSULT_APPOINTMENT',
  context: {
    aiPhase: 'consult_support',
    depositLinkSent: false,
    depositPaid: false,
    consultType: 'appointment',
    hasUpcomingTattoo: false,
    tattooCompleted: false,
    lost: false
  }
}
âŒ Error syncing opportunity stage after consult mode = appointment: Request failed with status code 422
âŒ Pipeline sync response (appointment consult): 422 {
  message: [ 'property tags should not exist' ],
  error: 'Unprocessable Entity',
  statusCode: 422,
  traceId: '1fefade0-d33a-4a00-9b73-900e1f60eff7'
}
ğŸ§­ [PHASE] derived_phase snapshot {
  derived_phase: 'consult_path',
  canonical: {
    tattooSummary: 'pine trees',
    tattooPlacement: 'forearm',
    tattooSize: null,
    timeline: 'January',
    consultationType: null,
    consultationTypeLocked: false,
    depositLinkSent: false,
    depositPaid: false,
    holdAppointmentId: null
  },
  intents: {
    reschedule_intent: false,
    cancel_intent: false,
    scheduling_intent: false,
    slot_selection_intent: false,
    deposit_intent: false,
    consult_path_choice_intent: true,
    artist_guided_size_intent: false,
    process_or_price_question_intent: false,
    translator_affirm_intent: false
  },
  selected_handler: 'consult_path',
  routing_reason: 'consult_path_choice_intent',
  intent_flags: [ 'consult_path_choice_intent' ]
}
â±ï¸ [TIMING] Total handleInboundMessage took 1718ms
ğŸ¤– AI Response Summary: {
  bubblesCount: 0,
  phase: 'consult_path',
  handler: 'consult_path',
  reason: 'consult_path_choice_intent',
  fieldUpdatesKeys: []
}
ğŸ“¤ Sent 0/0 bubbles to GHL conversation
â„¹ï¸ No field_updates from AI to persist this turn
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ GHL MESSAGE WEBHOOK HIT
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Webhook Payload (non-empty fields): {
  "Tattoo Style": "nature/trees",
  "translator_explained": "Yes",
  "consultation_type": "appointment",
  "language_barrier_explained": "Yes",
  "Tattoo Placement": "forearm",
  "translator_needed": "Yes",
  "How Soon Is Client Deciding?": "January",
  "Tattoo Summary": "pine trees",
  "contact_id": "0mMtk2qB0rcAaGBislYN",
  "first_name": "Maria",
  "last_name": "Claflin",
  "full_name": "Maria Claflin",
  "tags": "dm consultation request",
  "country": "US",
  "date_created": "2025-12-16T06:56:26.803Z",
  "contact_type": "lead",
  "location": {
    "name": "Studio AZ Tattoo",
    "address": "333 Washington Ave N STE 100",
    "city": "Minneapolis",
    "state": "Minnesota",
    "country": "US",
    "postalCode": "55401",
    "fullAddress": "333 Washington Ave N STE 100, Minneapolis Minnesota 55401",
    "id": "mUemx2jG4wly4kJWBkI4"
  },
  "message": {
    "type": 11,
    "body": "Yes"
  },
  "workflow": {
    "id": "8cf237bb-6cb1-4240-8ca5-b797bba8b769",
    "name": "Testing Ai Bot"
  },
  "contact": {
    "attributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    },
    "lastAttributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    }
  },
  "customData": {
    "contactId": "0mMtk2qB0rcAaGBislYN",
    "messageBody": "Yes"
  }
}
ğŸ“© Incoming message text: Yes
ğŸ‘¤ Contact ID: 0mMtk2qB0rcAaGBislYN
ğŸ“‹ Webhook custom fields extracted: {
  "tattoo_style": "nature/trees",
  "translator_explained": "Yes",
  "consultation_type": "appointment",
  "tattoo_placement": "forearm",
  "translator_needed": "Yes",
  "how_soon_is_client_deciding": "January",
  "tattoo_summary": "pine trees"
}
ğŸ‘¤ Contact: Maria Claflin
ğŸ“‹ Contact custom fields (merged): {
  "12b2o4ydlfo99fa4ycuk": "nature/trees",
  "jd8yhvksbi4agqjqoeov": "forearm",
  "xagtmfmbxtfchdo2oyf7": "pine trees",
  "ra4nk80wma8eqklcfxst": "January",
  "myuihlqvwgjnrnmy1hzu": "Yes",
  "gm2pvo90ynbdhekv5g64": "appointment",
  "ikiju6c8apzchvhsyfwr": "Yes",
  "qvuq2wdv3drhbkhts6td": "Yes",
  "tattoo_style": "nature/trees",
  "translator_explained": "Yes",
  "consultation_type": "appointment",
  "tattoo_placement": "forearm",
  "translator_needed": "Yes",
  "how_soon_is_client_deciding": "January",
  "tattoo_summary": "pine trees"
}
ğŸ“¡ Channel context: {
  isDm: true,
  hasPhone: false,
  isWhatsApp: false,
  isSms: false,
  channelType: 'facebook',
  conversationId: null,
  phone: null
}
ğŸ“Š [PIPELINE] New lead from facebook - syncing entry stage...
ğŸ“Š [PIPELINE] Direct channel (facebook) â†’ starting at DISCOVERY
âŒ [PIPELINE] Failed to set entry stage: Request failed with status code 422
ğŸ§  [AI CONTEXT] Processing message: {
  messageText: 'Yes',
  contactId: '0mMtk2qB0rcAaGBislYN',
  contactName: 'Maria Claflin',
  consultExplained: undefined
}
ğŸ“Š [CANONICAL] State before routing: {
  tattooSummary: 'pine trees',
  tattooPlacement: 'forearm',
  tattooSize: null,
  timeline: 'January',
  consultationType: 'appointment',
  depositPaid: false,
  derivedPhase: 'discovery'
}
ğŸ¯ [INTENTS] Detected intents: [ 'scheduling_intent', 'translator_affirm_intent' ] from message: Yes
ğŸ“… [SLOT OFFER] Time preferences extracted: {
  preferredWeek: null,
  preferredDay: null,
  preferredTimeWindow: null,
  preferredMonth: 0,
  preferredYear: null,
  preferredWeekStartDate: null
}
ğŸ“… [SLOTS] Inputs {
  preferredWeek: null,
  preferredDay: null,
  preferredTimeWindow: null,
  preferredMonth: 0,
  preferredYear: null,
  preferredWeekStartDate: null,
  nowIso: '2025-12-16T06:59:27.911Z',
  tzOffsetMinutes: 0
}
ğŸ“… [SLOTS] Month preference "Jan" 2026 - fetching full month
ğŸ“… [SLOTS] Fetching real GHL slots from 2026-01-01T00:00:00.000Z to 2026-01-31T23:59:59.999Z
âœ… [GHL CALENDAR] Found 12 free slots for calendar 2EJcAtrllnYOtuSx4Dua between 2026-01-01T00:00:00.000Z and 2026-01-31T23:59:59.999Z
ğŸ“… [SLOTS] Returning 4 real GHL slots
ğŸ§¾ [SLOT PERSIST] Writing last_sent_slots {
  contactId: '0mMtk2qB0rcAaGBislYN',
  slotsCount: 4,
  bytes: 616,
  sha1: 'ff82445b2246',
  preview: [
    {
      startTime: '2026-01-06T20:00:00.000Z',
      endTime: '2026-01-06T20:30:00.000Z',
      calendarId: '2EJcAtrllnYOtuSx4Dua',
      displayText: 'Tuesday, Jan 6 at 8pm'
    },
    {
      startTime: '2026-01-06T20:40:00.000Z',
      endTime: '2026-01-06T21:10:00.000Z',
      calendarId: '2EJcAtrllnYOtuSx4Dua',
      displayText: 'Tuesday, Jan 6 at 8:40pm'
    },
    {
      startTime: '2026-01-06T21:20:00.000Z',
      endTime: '2026-01-06T21:50:00.000Z',
      calendarId: '2EJcAtrllnYOtuSx4Dua',
      displayText: 'Tuesday, Jan 6 at 9:20pm'
    },
    {
      startTime: '2026-01-06T22:00:00.000Z',
      endTime: '2026-01-06T22:30:00.000Z',
      calendarId: '2EJcAtrllnYOtuSx4Dua',
      displayText: 'Tuesday, Jan 6 at 10pm'
    }
  ]
}
ğŸ§¾ [SLOT PERSIST] updateSystemFields result { contactId: '0mMtk2qB0rcAaGBislYN', ok: true }
âœ… [SLOT PERSIST] Saved 4 slots to GHL for contact 0mMtk2qB0rcAaGBislYN
ğŸ§­ [PHASE] derived_phase snapshot {
  derived_phase: 'discovery',
  canonical: {
    tattooSummary: 'pine trees',
    tattooPlacement: 'forearm',
    tattooSize: null,
    timeline: 'January',
    consultationType: 'appointment',
    consultationTypeLocked: false,
    depositLinkSent: false,
    depositPaid: false,
    holdAppointmentId: null
  },
  intents: {
    reschedule_intent: false,
    cancel_intent: false,
    scheduling_intent: true,
    slot_selection_intent: false,
    deposit_intent: false,
    consult_path_choice_intent: false,
    artist_guided_size_intent: false,
    process_or_price_question_intent: false,
    translator_affirm_intent: true
  },
  selected_handler: 'deterministic',
  routing_reason: 'scheduling_intent',
  intent_flags: [ 'scheduling_intent', 'translator_affirm_intent' ]
}
â±ï¸ [TIMING] Total handleInboundMessage took 849ms
ğŸ¤– AI Response Summary: {
  bubblesCount: 1,
  phase: 'discovery',
  handler: 'deterministic',
  reason: 'scheduling_intent',
  fieldUpdatesKeys: [ 'consult_explained' ]
}
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: true, hasPhone: false }
ğŸ” No conversationId provided for DM, searching for DM conversation...
ğŸ” No DM conversation found for contact
ğŸ” No existing DM conversation found, will try to infer type from contact...
ğŸ” No DM conversation found for contact
inferConversationMessageType: no DM conversation found, checking contact tags...
ğŸ“¨ Sending DM via GHL (creating new conversation): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  locationId: 'mUemx2jG4wly4kJWBkI4',
  message: 'I pulled a few openings for a consult with an artist:\n' +
    '1) Tuesday, Jan 6 at 8pm\n' +
    '2) Tuesday, Jan 6 at 8:40pm\n' +
    '3) Tuesday, Jan 6 at 9:20pm\n' +
    '4) Tuesday, Jan 6 at 10pm\n' +
    '\n' +
    'Which works best?',
  type: 'FB'
}
ğŸ“¨ GHL DM message response (new conversation): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
ğŸ“¤ Sent 1/1 bubbles to GHL conversation
updateTattooFields: no mapped fields to update for contact 0mMtk2qB0rcAaGBislYN
âœ… Persisted field_updates: [ 'consult_explained' ]
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ GHL MESSAGE WEBHOOK HIT
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Webhook Payload (non-empty fields): {
  "Tattoo Style": "nature/trees",
  "last_sent_slots": "[{\"startTime\":\"2026-01-06T20:00:00.000Z\",\"endTime\":\"2026-01-06T20:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8pm\"},{\"startTime\":\"2026-01-06T20:40:00.000Z\",\"endTime\":\"2026-01-06T21:10:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8:40pm\"},{\"startTime\":\"2026-01-06T21:20:00.000Z\",\"endTime\":\"2026-01-06T21:50:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 9:20pm\"},{\"startTime\":\"2026-01-06T22:00:00.000Z\",\"endTime\":\"2026-01-06T22:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 10pm\"}]",
  "times_sent": "Yes",
  "translator_explained": "Yes",
  "translator_confirmed": "Yes",
  "consultation_type": "appointment",
  "language_barrier_explained": "Yes",
  "Tattoo Placement": "forearm",
  "translator_needed": "Yes",
  "How Soon Is Client Deciding?": "January",
  "Tattoo Summary": "pine trees",
  "contact_id": "0mMtk2qB0rcAaGBislYN",
  "first_name": "Maria",
  "last_name": "Claflin",
  "full_name": "Maria Claflin",
  "tags": "dm consultation request",
  "country": "US",
  "date_created": "2025-12-16T06:56:26.803Z",
  "contact_type": "lead",
  "location": {
    "name": "Studio AZ Tattoo",
    "address": "333 Washington Ave N STE 100",
    "city": "Minneapolis",
    "state": "Minnesota",
    "country": "US",
    "postalCode": "55401",
    "fullAddress": "333 Washington Ave N STE 100, Minneapolis Minnesota 55401",
    "id": "mUemx2jG4wly4kJWBkI4"
  },
  "message": {
    "type": 11,
    "body": "Tuesday Jan 6 at 8pm"
  },
  "workflow": {
    "id": "8cf237bb-6cb1-4240-8ca5-b797bba8b769",
    "name": "Testing Ai Bot"
  },
  "contact": {
    "attributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    },
    "lastAttributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    }
  },
  "customData": {
    "contactId": "0mMtk2qB0rcAaGBislYN",
    "messageBody": "Tuesday Jan 6 at 8pm"
  }
}
ğŸ“© Incoming message text: Tuesday Jan 6 at 8pm
ğŸ‘¤ Contact ID: 0mMtk2qB0rcAaGBislYN
ğŸ“‹ Webhook custom fields extracted: {
  "tattoo_style": "nature/trees",
  "last_sent_slots": "[{\"startTime\":\"2026-01-06T20:00:00.000Z\",\"endTime\":\"2026-01-06T20:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8pm\"},{\"startTime\":\"2026-01-06T20:40:00.000Z\",\"endTime\":\"2026-01-06T21:10:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8:40pm\"},{\"startTime\":\"2026-01-06T21:20:00.000Z\",\"endTime\":\"2026-01-06T21:50:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 9:20pm\"},{\"startTime\":\"2026-01-06T22:00:00.000Z\",\"endTime\":\"2026-01-06T22:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 10pm\"}]",
  "times_sent": "Yes",
  "translator_explained": "Yes",
  "translator_confirmed": "Yes",
  "consultation_type": "appointment",
  "tattoo_placement": "forearm",
  "translator_needed": "Yes",
  "how_soon_is_client_deciding": "January",
  "tattoo_summary": "pine trees"
}
ğŸ‘¤ Contact: Maria Claflin
ğŸ“‹ Contact custom fields (merged): {
  "12b2o4ydlfo99fa4ycuk": "nature/trees",
  "jd8yhvksbi4agqjqoeov": "forearm",
  "xagtmfmbxtfchdo2oyf7": "pine trees",
  "ra4nk80wma8eqklcfxst": "January",
  "myuihlqvwgjnrnmy1hzu": "Yes",
  "gm2pvo90ynbdhekv5g64": "appointment",
  "ikiju6c8apzchvhsyfwr": "Yes",
  "qvuq2wdv3drhbkhts6td": "Yes",
  "whwh3aco0mzavhb0vizw": "Yes",
  "a832mlwirz5cv6xaktna": "[{\"startTime\":\"2026-01-06T20:00:00.000Z\",\"endTime\":\"2026-01-06T20:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8pm\"},{\"startTime\":\"2026-01-06T20:40:00.000Z\",\"endTime\":\"2026-01-06T21:10:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8:40pm\"},{\"startTime\":\"2026-01-06T21:20:00.000Z\",\"endTime\":\"2026-01-06T21:50:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 9:20pm\"},{\"startTime\":\"2026-01-06T22:00:00.000Z\",\"endTime\":\"2026-01-06T22:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 10pm\"}]",
  "eah8fdi5pwfxsqqfd45a": "Yes",
  "tattoo_style": "nature/trees",
  "last_sent_slots": "[{\"startTime\":\"2026-01-06T20:00:00.000Z\",\"endTime\":\"2026-01-06T20:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8pm\"},{\"startTime\":\"2026-01-06T20:40:00.000Z\",\"endTime\":\"2026-01-06T21:10:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8:40pm\"},{\"startTime\":\"2026-01-06T21:20:00.000Z\",\"endTime\":\"2026-01-06T21:50:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 9:20pm\"},{\"startTime\":\"2026-01-06T22:00:00.000Z\",\"endTime\":\"2026-01-06T22:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 10pm\"}]",
  "times_sent": "Yes",
  "translator_explained": "Yes",
  "translator_confirmed": "Yes",
  "consultation_type": "appointment",
  "tattoo_placement": "forearm",
  "translator_needed": "Yes",
  "how_soon_is_client_deciding": "January",
  "tattoo_summary": "pine trees"
}
ğŸ“¡ Channel context: {
  isDm: true,
  hasPhone: false,
  isWhatsApp: false,
  isSms: false,
  channelType: 'facebook',
  conversationId: null,
  phone: null
}
ğŸ“Š [PIPELINE] New lead from facebook - syncing entry stage...
ğŸ“Š [PIPELINE] Direct channel (facebook) â†’ starting at DISCOVERY
âŒ [PIPELINE] Failed to set entry stage: Request failed with status code 422
ğŸ§  [AI CONTEXT] Processing message: {
  messageText: 'Tuesday Jan 6 at 8pm',
  contactId: '0mMtk2qB0rcAaGBislYN',
  contactName: 'Maria Claflin',
  consultExplained: undefined
}
ğŸ“Š [CANONICAL] State before routing: {
  tattooSummary: 'pine trees',
  tattooPlacement: 'forearm',
  tattooSize: null,
  timeline: 'January',
  consultationType: 'appointment',
  depositPaid: false,
  derivedPhase: 'scheduling'
}
ğŸ¯ [INTENTS] Detected intents: [ 'slot_selection_intent' ] from message: Tuesday Jan 6 at 8pm
âœ… Matched day name with time: tuesday â†’ slot 1
ğŸ§­ [SLOT CHOICE] parseTimeSelection -> 0 number chosenSlot 2026-01-06T20:00:00.000Z
âš ï¸ Failed to create Google Meet (continuing without link): Missing Google OAuth credentials (client id/secret/refresh token)
âœ… Created appointment: {
  appointmentId: 'DgQ04xnStH0zIQByBObf',
  calendarId: '2EJcAtrllnYOtuSx4Dua',
  contactId: '0mMtk2qB0rcAaGBislYN',
  startTime: '2026-01-06T20:00:00.000Z',
  appointmentStatus: 'new'
}
âœ… Created appointment (status: new): {
  appointmentId: 'DgQ04xnStH0zIQByBObf',
  calendarId: '2EJcAtrllnYOtuSx4Dua',
  contactId: '0mMtk2qB0rcAaGBislYN',
  startTime: '2026-01-06T20:00:00.000Z',
  appointmentStatus: 'new',
  depositPaid: false,
  translatorAppointmentId: null
}
[Square] Creating payment link (HTTP) with body: {
  contactId: '0mMtk2qB0rcAaGBislYN',
  amountCents: 10000,
  currency: 'USD',
  env: 'sandbox'
}
ğŸ’³ Square payment link created (HTTP): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  paymentLinkId: 'UTQ5SUSETIDCTGBS',
  url: 'https://sandbox.square.link/u/1TpH13Ii'
}
âŒ [PIPELINE] Failed to transition to DEPOSIT_PENDING: Request failed with status code 422
ğŸ§­ [PHASE] derived_phase snapshot {
  derived_phase: 'scheduling',
  canonical: {
    tattooSummary: 'pine trees',
    tattooPlacement: 'forearm',
    tattooSize: null,
    timeline: 'January',
    consultationType: 'appointment',
    consultationTypeLocked: false,
    depositLinkSent: false,
    depositPaid: false,
    holdAppointmentId: null
  },
  intents: {
    reschedule_intent: false,
    cancel_intent: false,
    scheduling_intent: false,
    slot_selection_intent: true,
    deposit_intent: false,
    consult_path_choice_intent: false,
    artist_guided_size_intent: false,
    process_or_price_question_intent: false,
    translator_affirm_intent: false
  },
  selected_handler: 'deterministic',
  routing_reason: 'slot_selection',
  intent_flags: [ 'slot_selection_intent' ]
}
â±ï¸ [TIMING] Total handleInboundMessage took 1475ms
ğŸ¤– AI Response Summary: {
  bubblesCount: 1,
  phase: 'scheduling',
  handler: 'deterministic',
  reason: 'slot_selection',
  fieldUpdatesKeys: [ 'consult_explained' ]
}
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: true, hasPhone: false }
ğŸ” No conversationId provided for DM, searching for DM conversation...
ğŸ” No DM conversation found for contact
ğŸ” No existing DM conversation found, will try to infer type from contact...
ğŸ” No DM conversation found for contact
inferConversationMessageType: no DM conversation found, checking contact tags...
ğŸ“¨ Sending DM via GHL (creating new conversation): {
  contactId: '0mMtk2qB0rcAaGBislYN',
  locationId: 'mUemx2jG4wly4kJWBkI4',
  message: 'Got you for Tuesday, Jan 6 at 8pm.\n' +
    "To lock in your consultation, we require a $100 deposit. It's fully refundable if you don't end up loving the design, and it goes toward your tattoo total.\n" +
    '\n' +
    "Here's the link: https://sandbox.square.link/u/1TpH13Ii\n" +
    "I'll keep that spot on hold for about 20 minutes.",
  type: 'FB'
}
ğŸ“¨ GHL DM message response (new conversation): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
ğŸ“¤ Sent 1/1 bubbles to GHL conversation
updateTattooFields: no mapped fields to update for contact 0mMtk2qB0rcAaGBislYN
âœ… Persisted field_updates: [ 'consult_explained' ]
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ GHL MESSAGE WEBHOOK HIT
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Webhook Payload (non-empty fields): {
  "Tattoo Style": "nature/trees",
  "last_sent_slots": "[{\"startTime\":\"2026-01-06T20:00:00.000Z\",\"endTime\":\"2026-01-06T20:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8pm\"},{\"startTime\":\"2026-01-06T20:40:00.000Z\",\"endTime\":\"2026-01-06T21:10:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8:40pm\"},{\"startTime\":\"2026-01-06T21:20:00.000Z\",\"endTime\":\"2026-01-06T21:50:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 9:20pm\"},{\"startTime\":\"2026-01-06T22:00:00.000Z\",\"endTime\":\"2026-01-06T22:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 10pm\"}]",
  "times_sent": "Yes",
  "hold_last_activity_at": "2025-12-16T06:59:57.474Z",
  "translator_explained": "Yes",
  "translator_confirmed": "Yes",
  "hold_warning_sent": "No",
  "consultation_type": "appointment",
  "language_barrier_explained": "Yes",
  "Deposit Link Sent": "Yes",
  "Tattoo Placement": "forearm",
  "hold_appointment_id": "DgQ04xnStH0zIQByBObf",
  "translator_needed": "Yes",
  "How Soon Is Client Deciding?": "January",
  "Tattoo Summary": "pine trees",
  "contact_id": "0mMtk2qB0rcAaGBislYN",
  "first_name": "Maria",
  "last_name": "Claflin",
  "full_name": "Maria Claflin",
  "tags": "dm consultation request",
  "country": "US",
  "date_created": "2025-12-16T06:56:26.803Z",
  "contact_type": "lead",
  "location": {
    "name": "Studio AZ Tattoo",
    "address": "333 Washington Ave N STE 100",
    "city": "Minneapolis",
    "state": "Minnesota",
    "country": "US",
    "postalCode": "55401",
    "fullAddress": "333 Washington Ave N STE 100, Minneapolis Minnesota 55401",
    "id": "mUemx2jG4wly4kJWBkI4"
  },
  "user": {
    "firstName": "Claudia",
    "lastName": "Chavarria",
    "email": "tigsatattoos@gmail.com"
  },
  "message": {
    "type": 11,
    "body": "Video call"
  },
  "workflow": {
    "id": "8cf237bb-6cb1-4240-8ca5-b797bba8b769",
    "name": "Testing Ai Bot"
  },
  "contact": {
    "attributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    },
    "lastAttributionSource": {
      "photoUrl": null,
      "sessionSource": "Social media",
      "adId": null,
      "productId": null,
      "videoUrl": null,
      "mediumId": "24364584283244494",
      "utmContent": null,
      "pSid": "24364584283244494",
      "medium": "facebook",
      "postId": null,
      "flowId": null
    }
  },
  "customData": {
    "contactId": "0mMtk2qB0rcAaGBislYN",
    "messageBody": "Video call"
  }
}
ğŸ“© Incoming message text: Video call
ğŸ‘¤ Contact ID: 0mMtk2qB0rcAaGBislYN
ğŸ“‹ Webhook custom fields extracted: {
  "tattoo_style": "nature/trees",
  "last_sent_slots": "[{\"startTime\":\"2026-01-06T20:00:00.000Z\",\"endTime\":\"2026-01-06T20:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8pm\"},{\"startTime\":\"2026-01-06T20:40:00.000Z\",\"endTime\":\"2026-01-06T21:10:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8:40pm\"},{\"startTime\":\"2026-01-06T21:20:00.000Z\",\"endTime\":\"2026-01-06T21:50:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 9:20pm\"},{\"startTime\":\"2026-01-06T22:00:00.000Z\",\"endTime\":\"2026-01-06T22:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 10pm\"}]",
  "times_sent": "Yes",
  "hold_last_activity_at": "2025-12-16T06:59:57.474Z",
  "translator_explained": "Yes",
  "translator_confirmed": "Yes",
  "hold_warning_sent": "No",
  "consultation_type": "appointment",
  "deposit_link_sent": "Yes",
  "tattoo_placement": "forearm",
  "hold_appointment_id": "DgQ04xnStH0zIQByBObf",
  "translator_needed": "Yes",
  "how_soon_is_client_deciding": "January",
  "tattoo_summary": "pine trees"
}
ğŸ‘¤ Contact: Maria Claflin
ğŸ“‹ Contact custom fields (merged): {
  "12b2o4ydlfo99fa4ycuk": "nature/trees",
  "jd8yhvksbi4agqjqoeov": "forearm",
  "xagtmfmbxtfchdo2oyf7": "pine trees",
  "ra4nk80wma8eqklcfxst": "January",
  "myuihlqvwgjnrnmy1hzu": "Yes",
  "gm2pvo90ynbdhekv5g64": "appointment",
  "ikiju6c8apzchvhsyfwr": "Yes",
  "qvuq2wdv3drhbkhts6td": "Yes",
  "whwh3aco0mzavhb0vizw": "Yes",
  "a832mlwirz5cv6xaktna": "[{\"startTime\":\"2026-01-06T20:00:00.000Z\",\"endTime\":\"2026-01-06T20:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8pm\"},{\"startTime\":\"2026-01-06T20:40:00.000Z\",\"endTime\":\"2026-01-06T21:10:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8:40pm\"},{\"startTime\":\"2026-01-06T21:20:00.000Z\",\"endTime\":\"2026-01-06T21:50:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 9:20pm\"},{\"startTime\":\"2026-01-06T22:00:00.000Z\",\"endTime\":\"2026-01-06T22:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 10pm\"}]",
  "eah8fdi5pwfxsqqfd45a": "Yes",
  "hnelct3ekpbjphnspnif": "2025-12-16T06:59:57.474Z",
  "emwcggyxu7uzasx6uwod": "No",
  "jszdgcpnyzab1s3alcjk": "Yes",
  "ma7faq854uotakf7qzy5": "DgQ04xnStH0zIQByBObf",
  "tattoo_style": "nature/trees",
  "last_sent_slots": "[{\"startTime\":\"2026-01-06T20:00:00.000Z\",\"endTime\":\"2026-01-06T20:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8pm\"},{\"startTime\":\"2026-01-06T20:40:00.000Z\",\"endTime\":\"2026-01-06T21:10:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 8:40pm\"},{\"startTime\":\"2026-01-06T21:20:00.000Z\",\"endTime\":\"2026-01-06T21:50:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 9:20pm\"},{\"startTime\":\"2026-01-06T22:00:00.000Z\",\"endTime\":\"2026-01-06T22:30:00.000Z\",\"calendarId\":\"2EJcAtrllnYOtuSx4Dua\",\"displayText\":\"Tuesday, Jan 6 at 10pm\"}]",
  "times_sent": "Yes",
  "hold_last_activity_at": "2025-12-16T06:59:57.474Z",
  "translator_explained": "Yes",
  "translator_confirmed": "Yes",
  "hold_warning_sent": "No",
  "consultation_type": "appointment",
  "deposit_link_sent": "Yes",
  "tattoo_placement": "forearm",
  "hold_appointment_id": "DgQ04xnStH0zIQByBObf",
  "translator_needed": "Yes",
  "how_soon_is_client_deciding": "January",
  "tattoo_summary": "pine trees"
}
ğŸ“¡ Channel context: {
  isDm: true,
  hasPhone: false,
  isWhatsApp: false,
  isSms: false,
  channelType: 'facebook',
  conversationId: null,
  phone: null
}
ğŸ“Š [PIPELINE] New lead from facebook - syncing entry stage...
ğŸ“Š [PIPELINE] Direct channel (facebook) â†’ starting at DISCOVERY
âŒ [PIPELINE] Failed to set entry stage: Request failed with status code 422
ğŸ§  [AI CONTEXT] Processing message: {
  messageText: 'Video call',
  contactId: '0mMtk2qB0rcAaGBislYN',
  contactName: 'Maria Claflin',
  consultExplained: undefined
}
ğŸ“Š [CANONICAL] State before routing: {
  tattooSummary: 'pine trees',
  tattooPlacement: 'forearm',
  tattooSize: null,
  timeline: 'January',
  consultationType: 'appointment',
  depositPaid: false,
  derivedPhase: 'deposit_pending'
}
ğŸ¯ [INTENTS] Detected intents: [ 'consult_path_choice_intent' ] from message: Video call
ğŸ“ [CONSULTATION_TYPE] Setting consultation_type="appointment" (translator needed) for contact 0mMtk2qB0rcAaGBislYN (detected from: "Video call")
âœ‰ï¸ sendConversationMessage context: { contactId: '0mMtk2qB0rcAaGBislYN', isDm: false, hasPhone: false }
ğŸ“¨ GHL conversations API response (fallback): { status: 201, contactId: '0mMtk2qB0rcAaGBislYN', type: 'FB' }
ğŸ“ [CONSULTATION_TYPE] Sent translator explanation message directly
ğŸ”„ [PIPELINE] Syncing opportunity stage for contact 0mMtk2qB0rcAaGBislYN: {
  currentStage: '(none)',
  targetStage: 'CONSULT_APPOINTMENT',
  context: {
    aiPhase: 'consult_support',
    depositLinkSent: false,
    depositPaid: false,
    consultType: 'appointment',
    hasUpcomingTattoo: false,
    tattooCompleted: false,
    lost: false
  }
}
âŒ Error syncing opportunity stage after consult mode = appointment: Request failed with status code 422
âŒ Pipeline sync response (appointment consult): 422 {
  message: [ 'property tags should not exist' ],
  error: 'Unprocessable Entity',
  statusCode: 422,
  traceId: 'f6c559e8-692d-4cde-8958-044f8a12a98a'
}
ğŸ§­ [PHASE] derived_phase snapshot {
  derived_phase: 'deposit_pending',
  canonical: {
    tattooSummary: 'pine trees',
    tattooPlacement: 'forearm',
    tattooSize: null,
    timeline: 'January',
    consultationType: 'appointment',
    consultationTypeLocked: false,
    depositLinkSent: true,
    depositPaid: false,
    holdAppointmentId: 'DgQ04xnStH0zIQByBObf'
  },
  intents: {
    reschedule_intent: false,
    cancel_intent: false,
    scheduling_intent: false,
    slot_selection_intent: false,
    deposit_intent: false,
    consult_path_choice_intent: true,
    artist_guided_size_intent: false,
    process_or_price_question_intent: false,
    translator_affirm_intent: false
  },
  selected_handler: 'consult_path',
  routing_reason: 'consult_path_choice_intent',
  intent_flags: [ 'consult_path_choice_intent' ]
}
â±ï¸ [TIMING] Total handleInboundMessage took 2525ms
ğŸ¤– AI Response Summary: {
  bubblesCount: 0,
  phase: 'deposit_pending',
  handler: 'consult_path',
  reason: 'consult_path_choice_intent',
  fieldUpdatesKeys: []
}
ğŸ“¤ Sent 0/0 bubbles to GHL conversation
â„¹ï¸ No field_updates from AI to persist this turn
ğŸ’¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•